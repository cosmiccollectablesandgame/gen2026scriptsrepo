<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 0;
      margin: 0;
      font-size: 14px;
      background: #f5f5f5;
    }
    .container {
      width: 100%;
      padding: 16px;
      min-height: 100vh;
    }
    h2 {
      color: #38761d;
      margin: 0 0 4px 0;
      font-size: 20px;
    }
    .subtitle {
      color: #666;
      font-size: 12px;
      margin-bottom: 16px;
    }

    /* Search */
    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .search-box input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .search-box input:focus {
      outline: none;
      border-color: #38761d;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
    }
    .btn-primary {
      background: #38761d;
      color: white;
    }
    .btn-primary:hover {
      background: #2d5f17;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
    }

    /* Summary */
    .summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    .stat-box {
      background: white;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #e0e0e0;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #333;
    }
    .stat-label {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }
    .stat-box.pending .stat-value { color: #e67c00; }
    .stat-box.ready .stat-value { color: #38761d; }
    .stat-box.balance .stat-value { color: #d32f2f; }

    /* Sections */
    .section {
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .section-header {
      padding: 10px 12px;
      background: #f8f9fa;
      font-weight: 600;
      font-size: 13px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-header .count {
      background: #38761d;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    .section-header.pending-section { border-left: 4px solid #e67c00; }
    .section-header.ready-section { border-left: 4px solid #38761d; }

    /* Preorder items */
    .preorder-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .preorder-item {
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    .preorder-item:last-child {
      border-bottom: none;
    }
    .preorder-item:hover {
      background: #f8f9fa;
    }
    .preorder-customer {
      font-weight: 600;
      color: #333;
      font-size: 13px;
    }
    .preorder-details {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .preorder-balance {
      font-weight: 600;
      color: #d32f2f;
    }
    .preorder-status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-deposit { background: #fff3e0; color: #e67c00; }
    .status-paid { background: #e8f5e9; color: #38761d; }
    .status-active { background: #e3f2fd; color: #1976d2; }

    /* Loading / Empty */
    .loading, .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    .loading::before {
      content: '‚è≥';
      display: block;
      font-size: 32px;
      margin-bottom: 10px;
    }
    .empty-state::before {
      content: 'üìã';
      display: block;
      font-size: 32px;
      margin-bottom: 10px;
    }

    /* Error */
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üì¶ Preorder Status</h2>
    <p class="subtitle">View and track customer preorders</p>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Filter by name, set, or item..." />
      <button class="btn btn-primary" onclick="loadPreorders()">Search</button>
      <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="loading" class="loading" style="display: none;">
      Loading preorders...
    </div>

    <div id="content">
      <!-- Summary -->
      <div class="summary" id="summary" style="display: none;">
        <div class="stat-box pending">
          <div class="stat-value" id="pendingCount">0</div>
          <div class="stat-label">Pending Payment</div>
        </div>
        <div class="stat-box ready">
          <div class="stat-value" id="readyCount">0</div>
          <div class="stat-label">Ready for Pickup</div>
        </div>
        <div class="stat-box balance">
          <div class="stat-value" id="totalBalance">$0</div>
          <div class="stat-label">Total Balance Due</div>
        </div>
      </div>

      <!-- Pending Payment Section -->
      <div class="section" id="pendingSection" style="display: none;">
        <div class="section-header pending-section">
          <span>üí≥ Pending Payment</span>
          <span class="count" id="pendingBadge">0</span>
        </div>
        <div class="preorder-list" id="pendingList"></div>
      </div>

      <!-- Ready for Pickup Section -->
      <div class="section" id="readySection" style="display: none;">
        <div class="section-header ready-section">
          <span>‚úÖ Ready for Pickup</span>
          <span class="count" id="readyBadge">0</span>
        </div>
        <div class="preorder-list" id="readyList"></div>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="empty-state">
        Click "Search" to load preorders, or enter a name to filter.
      </div>
    </div>
  </div>

  <script>
    // Load preorders on initial load
    document.addEventListener('DOMContentLoaded', function() {
      loadPreorders();
    });

    // Enter key triggers search
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        loadPreorders();
      }
    });

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      loadPreorders();
    }

    function loadPreorders() {
      var search = document.getElementById('searchInput').value.trim();

      showLoading(true);
      hideError();

      google.script.run
        .withSuccessHandler(onPreordersLoaded)
        .withFailureHandler(onError)
        .getOpenPreorders(search);
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      document.getElementById('emptyState').style.display = 'none';
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    function onError(error) {
      showLoading(false);
      document.getElementById('error').textContent = 'Error: ' + error.message;
      document.getElementById('error').style.display = 'block';
    }

    function onPreordersLoaded(data) {
      showLoading(false);

      if (!data) {
        showEmpty('No preorder data returned');
        return;
      }

      var pending = data.pendingPayment || [];
      var ready = data.readyForPickup || [];
      var summary = data.summary || {};

      // Update summary
      document.getElementById('pendingCount').textContent = summary.pendingPaymentCount || 0;
      document.getElementById('readyCount').textContent = summary.readyForPickupCount || 0;
      document.getElementById('totalBalance').textContent = formatCurrency(summary.totalBalanceDue || 0);
      document.getElementById('summary').style.display = 'grid';

      // Update badges
      document.getElementById('pendingBadge').textContent = pending.length;
      document.getElementById('readyBadge').textContent = ready.length;

      // Render pending list
      if (pending.length > 0) {
        document.getElementById('pendingList').innerHTML = pending.map(renderPreorderItem).join('');
        document.getElementById('pendingSection').style.display = 'block';
      } else {
        document.getElementById('pendingSection').style.display = 'none';
      }

      // Render ready list
      if (ready.length > 0) {
        document.getElementById('readyList').innerHTML = ready.map(renderPreorderItem).join('');
        document.getElementById('readySection').style.display = 'block';
      } else {
        document.getElementById('readySection').style.display = 'none';
      }

      // Show empty if both are empty
      if (pending.length === 0 && ready.length === 0) {
        showEmpty('No open preorders found');
      } else {
        document.getElementById('emptyState').style.display = 'none';
      }
    }

    function showEmpty(message) {
      document.getElementById('emptyState').textContent = message;
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('pendingSection').style.display = 'none';
      document.getElementById('readySection').style.display = 'none';
    }

    function renderPreorderItem(p) {
      var name = p.PreferredName || p.preferred_name_id || p.preferredNameId || 'Unknown';
      var setName = p.Set_Name || p.setName || '';
      var itemName = p.Item_Name || p.itemName || '';
      var qty = p.Qty || p.qty || 1;
      var balance = p.Balance_Due !== undefined ? p.Balance_Due : (p.balanceDue || 0);
      var status = p.Status || p.status || 'Active';

      var statusClass = 'status-active';
      var statusNorm = status.toLowerCase().replace(/_/g, ' ');
      if (statusNorm.includes('deposit')) statusClass = 'status-deposit';
      if (statusNorm.includes('paid') && !statusNorm.includes('deposit')) statusClass = 'status-paid';

      return '<div class="preorder-item">' +
        '<div class="preorder-customer">' + escapeHtml(name) + '</div>' +
        '<div class="preorder-details">' +
          '<strong>' + escapeHtml(setName) + '</strong> ‚Äî ' + escapeHtml(itemName) +
          ' (x' + qty + ')' +
          (balance > 0 ? ' ‚Äî <span class="preorder-balance">' + formatCurrency(balance) + ' due</span>' : '') +
        '</div>' +
        '<div style="margin-top: 4px;">' +
          '<span class="preorder-status ' + statusClass + '">' + escapeHtml(status) + '</span>' +
        '</div>' +
      '</div>';
    }

    function formatCurrency(val) {
      var num = parseFloat(val) || 0;
      return '$' + num.toFixed(2);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }
  </script>
</body>
</html>
