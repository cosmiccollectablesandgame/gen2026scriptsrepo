<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 0;
      margin: 0;
      font-size: 14px;
      background: #f5f5f5;
    }
    .container {
      width: 100%;
      padding: 16px;
      min-height: 100vh;
    }
    h2 {
      color: #38761d;
      margin: 0 0 4px 0;
      font-size: 20px;
    }
    .subtitle {
      color: #666;
      font-size: 12px;
      margin-bottom: 16px;
    }

    /* Search */
    .search-box {
      margin-bottom: 16px;
    }
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    .search-box input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .search-box input:focus {
      outline: none;
      border-color: #38761d;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }
    .btn-primary {
      background: #38761d;
      color: white;
    }
    .btn-primary:hover {
      background: #2d5f17;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    .btn-info {
      background: #1976d2;
      color: white;
    }
    .btn-info:hover {
      background: #1565c0;
    }

    /* Summary */
    .summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }
    .stat-box {
      background: white;
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #e0e0e0;
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #333;
    }
    .stat-label {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }
    .stat-box.pending .stat-value { color: #e67c00; }
    .stat-box.ready .stat-value { color: #38761d; }
    .stat-box.balance .stat-value { color: #d32f2f; }

    /* Sections */
    .section {
      background: white;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .section-header {
      padding: 10px 12px;
      background: #f8f9fa;
      font-weight: 600;
      font-size: 13px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .section-header .count {
      background: #38761d;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    .section-header.pending-section { border-left: 4px solid #e67c00; }
    .section-header.ready-section { border-left: 4px solid #38761d; }

    /* Preorder items */
    .preorder-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .preorder-item {
      padding: 10px 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    .preorder-item:last-child {
      border-bottom: none;
    }
    .preorder-item:hover {
      background: #f8f9fa;
    }
    .preorder-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .preorder-customer {
      font-weight: 600;
      color: #333;
      font-size: 13px;
    }
    .preorder-id {
      font-size: 11px;
      color: #888;
    }
    .preorder-details {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .preorder-balance {
      font-weight: 600;
      color: #d32f2f;
    }
    .preorder-status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .status-deposit { background: #fff3e0; color: #e67c00; }
    .status-paid { background: #e8f5e9; color: #38761d; }
    .status-active { background: #e3f2fd; color: #1976d2; }

    .item-list {
      margin-top: 6px;
      padding-left: 12px;
      border-left: 2px solid #e0e0e0;
    }
    .item-row {
      font-size: 11px;
      color: #555;
      margin: 2px 0;
    }

    /* Loading / Empty */
    .loading, .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    .loading::before {
      content: '';
      display: block;
      font-size: 32px;
      margin-bottom: 10px;
    }
    .empty-state::before {
      content: '';
      display: block;
      font-size: 32px;
      margin-bottom: 10px;
    }

    /* Error */
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 13px;
    }
    .error-hint {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
    }

    /* Mode indicator */
    .mode-indicator {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
      padding: 4px 8px;
      background: #f0f0f0;
      border-radius: 4px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Preorder Status</h2>
    <p class="subtitle">View and track customer preorders</p>

    <div class="search-box">
      <div class="search-row">
        <input type="text" id="searchInput" placeholder="Player name or search term..." />
        <button class="btn btn-primary" onclick="lookupPlayer()">Lookup Player</button>
      </div>
      <div class="search-row">
        <button class="btn btn-info" onclick="showAllOpen()">Show All Open</button>
        <button class="btn btn-secondary" onclick="searchPreorders()">Search</button>
        <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
      </div>
    </div>

    <div id="error" class="error" style="display: none;">
      <div id="errorMessage"></div>
      <div class="error-hint">Check that Preorders_Sold sheet exists and has correct headers.</div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      Loading preorders...
    </div>

    <div id="content">
      <div id="modeIndicator" class="mode-indicator" style="display: none;"></div>

      <!-- Summary -->
      <div class="summary" id="summary" style="display: none;">
        <div class="stat-box pending">
          <div class="stat-value" id="pendingCount">0</div>
          <div class="stat-label">Pending Payment</div>
        </div>
        <div class="stat-box ready">
          <div class="stat-value" id="readyCount">0</div>
          <div class="stat-label">Ready for Pickup</div>
        </div>
        <div class="stat-box balance">
          <div class="stat-value" id="totalBalance">$0</div>
          <div class="stat-label">Total Balance Due</div>
        </div>
      </div>

      <!-- Pending Payment Section -->
      <div class="section" id="pendingSection" style="display: none;">
        <div class="section-header pending-section">
          <span>Pending Payment</span>
          <span class="count" id="pendingBadge">0</span>
        </div>
        <div class="preorder-list" id="pendingList"></div>
      </div>

      <!-- Ready for Pickup Section -->
      <div class="section" id="readySection" style="display: none;">
        <div class="section-header ready-section">
          <span>Ready for Pickup</span>
          <span class="count" id="readyBadge">0</span>
        </div>
        <div class="preorder-list" id="readyList"></div>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="empty-state">
        Click "Show All Open" to load all open preorders, or enter a player name and click "Lookup Player".
      </div>
    </div>
  </div>

  <script>
    var currentMode = null;

    // Load all open preorders on initial load
    document.addEventListener('DOMContentLoaded', function() {
      // Don't auto-load - let user choose
    });

    // Enter key triggers player lookup
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        var val = e.target.value.trim();
        if (val) {
          lookupPlayer();
        } else {
          showAllOpen();
        }
      }
    });

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      hideError();
      document.getElementById('summary').style.display = 'none';
      document.getElementById('pendingSection').style.display = 'none';
      document.getElementById('readySection').style.display = 'none';
      document.getElementById('modeIndicator').style.display = 'none';
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('emptyState').textContent = 'Click "Show All Open" to load all open preorders, or enter a player name and click "Lookup Player".';
    }

    function lookupPlayer() {
      var name = document.getElementById('searchInput').value.trim();
      if (!name) {
        showError('Please enter a player name');
        return;
      }

      currentMode = 'player';
      showLoading(true);
      hideError();

      google.script.run
        .withSuccessHandler(onApiResponse)
        .withFailureHandler(onError)
        .api_getPreorderStatus({ mode: 'player', preferredName: name });
    }

    function showAllOpen() {
      currentMode = 'all_open';
      showLoading(true);
      hideError();

      google.script.run
        .withSuccessHandler(onApiResponse)
        .withFailureHandler(onError)
        .api_getPreorderStatus({ mode: 'all_open' });
    }

    function searchPreorders() {
      var search = document.getElementById('searchInput').value.trim();
      currentMode = 'search';
      showLoading(true);
      hideError();

      google.script.run
        .withSuccessHandler(onApiResponse)
        .withFailureHandler(onError)
        .api_getPreorderStatus({ mode: 'search', search: search });
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
      document.getElementById('emptyState').style.display = 'none';
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('error').style.display = 'block';
    }

    function onError(error) {
      showLoading(false);
      var msg = error.message || String(error);
      showError('Error: ' + msg);
      console.error('API Error:', error);
    }

    function onApiResponse(data) {
      showLoading(false);

      if (!data) {
        showError('No response from server');
        return;
      }

      if (!data.ok) {
        var errorMsg = data.errors && data.errors.length > 0
          ? data.errors.join('; ')
          : 'Unknown error';
        showError(errorMsg);
        return;
      }

      // Show mode indicator
      var modeText = '';
      if (data.mode === 'player') {
        modeText = 'Showing preorders for: ' + (document.getElementById('searchInput').value || 'player');
      } else if (data.mode === 'all_open') {
        modeText = 'Showing all open preorders';
      } else if (data.mode === 'search') {
        modeText = 'Search results';
      }
      document.getElementById('modeIndicator').textContent = modeText + ' (Source: ' + (data.sourceSheet || 'unknown') + ')';
      document.getElementById('modeIndicator').style.display = 'inline-block';

      // Separate into pending payment and ready for pickup
      var pending = [];
      var ready = [];
      var totalBalance = 0;

      for (var i = 0; i < data.orders.length; i++) {
        var order = data.orders[i];
        if (!order.isOpen) continue;

        if (order.balanceDue > 0) {
          pending.push(order);
          totalBalance += order.balanceDue;
        } else {
          ready.push(order);
        }
      }

      // Update summary
      document.getElementById('pendingCount').textContent = pending.length;
      document.getElementById('readyCount').textContent = ready.length;
      document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
      document.getElementById('summary').style.display = 'grid';

      // Update badges
      document.getElementById('pendingBadge').textContent = pending.length;
      document.getElementById('readyBadge').textContent = ready.length;

      // Render pending list
      if (pending.length > 0) {
        document.getElementById('pendingList').innerHTML = pending.map(renderOrderItem).join('');
        document.getElementById('pendingSection').style.display = 'block';
      } else {
        document.getElementById('pendingSection').style.display = 'none';
      }

      // Render ready list
      if (ready.length > 0) {
        document.getElementById('readyList').innerHTML = ready.map(renderOrderItem).join('');
        document.getElementById('readySection').style.display = 'block';
      } else {
        document.getElementById('readySection').style.display = 'none';
      }

      // Show empty if both are empty
      if (pending.length === 0 && ready.length === 0) {
        var emptyMsg = data.mode === 'player'
          ? 'No open preorders found for this player'
          : 'No open preorders found';
        showEmpty(emptyMsg);
      } else {
        document.getElementById('emptyState').style.display = 'none';
      }
    }

    function showEmpty(message) {
      document.getElementById('emptyState').textContent = message;
      document.getElementById('emptyState').style.display = 'block';
      document.getElementById('pendingSection').style.display = 'none';
      document.getElementById('readySection').style.display = 'none';
    }

    function renderOrderItem(order) {
      var name = order.preferredName || 'Unknown';
      var preorderId = order.preorderId || '';
      var status = order.status || 'Active';
      var balance = order.balanceDue || 0;
      var items = order.items || [];

      var statusClass = 'status-active';
      var statusNorm = String(status).toLowerCase().replace(/_/g, ' ');
      if (statusNorm.includes('deposit')) statusClass = 'status-deposit';
      if (statusNorm.includes('paid') && !statusNorm.includes('deposit')) statusClass = 'status-paid';

      var html = '<div class="preorder-item">';
      html += '<div class="preorder-header">';
      html += '<div>';
      html += '<div class="preorder-customer">' + escapeHtml(name) + '</div>';
      if (preorderId) {
        html += '<div class="preorder-id">Order: ' + escapeHtml(preorderId) + '</div>';
      }
      html += '</div>';
      if (balance > 0) {
        html += '<div class="preorder-balance">' + formatCurrency(balance) + ' due</div>';
      }
      html += '</div>';

      // Render items
      if (items.length > 0) {
        html += '<div class="item-list">';
        for (var i = 0; i < Math.min(items.length, 5); i++) {
          var item = items[i];
          html += '<div class="item-row">';
          html += escapeHtml(item.setName || '') + ' - ' + escapeHtml(item.itemName || '');
          if (item.qty > 1) {
            html += ' (x' + item.qty + ')';
          }
          html += '</div>';
        }
        if (items.length > 5) {
          html += '<div class="item-row">... and ' + (items.length - 5) + ' more items</div>';
        }
        html += '</div>';
      }

      html += '<div style="margin-top: 6px;">';
      html += '<span class="preorder-status ' + statusClass + '">' + escapeHtml(status) + '</span>';
      if (order.createdAt) {
        html += ' <span style="font-size: 10px; color: #888;">Created: ' + escapeHtml(order.createdAt) + '</span>';
      }
      html += '</div>';
      html += '</div>';

      return html;
    }

    function formatCurrency(val) {
      var num = parseFloat(val) || 0;
      return '$' + num.toFixed(2);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }
  </script>
</body>
</html>
