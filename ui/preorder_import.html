<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      padding: 12px;
      margin: 0;
      font-size: 13px;
      background: #f5f5f5;
    }

    h2 {
      color: #1a73e8;
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .info {
      background: #e8f4fd;
      padding: 8px 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .form-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      color: #333;
      font-size: 12px;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      font-family: Arial, sans-serif;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 2px rgba(26,115,232,0.15);
    }

    .items-section {
      margin-top: 10px;
    }

    .items-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .items-header h3 {
      margin: 0;
      font-size: 13px;
      color: #333;
    }

    .btn-add-item {
      background: #1a73e8;
      color: #fff;
      border: none;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
    }

    .btn-add-item:hover {
      background: #1557b0;
    }

    #itemsContainer {
      max-height: 260px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 6px;
      background: #fafafa;
    }

    .empty-state {
      text-align: center;
      padding: 20px 8px;
      color: #999;
      font-size: 12px;
    }

    .item-row {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 6px;
    }

    .item-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .item-row-number {
      font-weight: 600;
      color: #666;
      font-size: 12px;
    }

    .btn-remove {
      background: #dc3545;
      color: #fff;
      border: none;
      padding: 2px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }

    .btn-remove:hover {
      background: #c82333;
    }

    .item-fields {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 6px;
      margin-bottom: 6px;
    }

    .field-group {
      margin-bottom: 4px;
    }

    .field-group label {
      font-size: 11px;
      margin-bottom: 2px;
    }

    .numbers-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
    }

    .preview-section {
      display: none;
      margin-top: 10px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      font-size: 12px;
    }

    .preview-section h3 {
      margin: 0 0 6px 0;
      font-size: 13px;
      color: #333;
    }

    .preview-set-name {
      font-weight: 600;
      color: #1a73e8;
      margin-bottom: 4px;
    }

    .preview-item {
      background: #fff;
      padding: 6px;
      margin-bottom: 4px;
      border-radius: 3px;
      border-left: 3px solid #1a73e8;
    }

    #status {
      margin-top: 8px;
      padding: 6px 8px;
      border-radius: 4px;
      display: none;
      font-size: 12px;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .buttons {
      margin-top: 10px;
      text-align: right;
    }

    button {
      padding: 6px 12px;
      margin-left: 6px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
    }

    .btn-primary {
      background: #1a73e8;
      color: white;
    }

    .btn-primary:hover {
      background: #1557b0;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-success:disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <h2>Preorder Buckets</h2>

  <div class="info">
    Enter a <strong>Set Name</strong> and one or more items.<br>
    Each item becomes a row in <strong>Preorders_Buckets</strong>.
  </div>

  <div class="form-group">
    <label for="setNameInput">Set Name *</label>
    <input type="text" id="setNameInput" placeholder="e.g., MH3, Foundations, Aetherdrift" autocomplete="off">
  </div>

  <div class="items-section">
    <div class="items-header">
      <h3>Items</h3>
      <button type="button" class="btn-add-item" id="btnAddItem">+ Add Item</button>
    </div>
    <div id="itemsContainer">
      <div class="empty-state" id="emptyState">
        No items yet. Click “+ Add Item” to begin.
      </div>
    </div>
  </div>

  <div class="preview-section" id="previewSection">
    <h3>Preview</h3>
    <div id="previewContent"></div>
  </div>

  <div id="status"></div>

  <div class="buttons">
    <button type="button" class="btn-secondary" id="btnClose">Close</button>
    <button type="button" class="btn-primary" id="btnPreview">Preview</button>
    <button type="button" class="btn-success" id="btnImport" disabled>Import</button>
  </div>

  <script>
    let itemCounter = 0;

    document.addEventListener('DOMContentLoaded', function () {
      document.getElementById('btnAddItem').addEventListener('click', addItemRow);
      document.getElementById('btnPreview').addEventListener('click', onPreview);
      document.getElementById('btnImport').addEventListener('click', onImport);
      document.getElementById('btnClose').addEventListener('click', function () {
        google.script.host.close();
      });

      document.getElementById('itemsContainer').addEventListener('click', function (e) {
        if (e.target.classList.contains('btn-remove')) {
          const id = e.target.getAttribute('data-item-id');
          removeItemRow(id);
        }
      });

      // Start with one row
      addItemRow();
    });

    function addItemRow() {
      itemCounter++;
      const id = 'item-' + itemCounter;

      const emptyState = document.getElementById('emptyState');
      if (emptyState) emptyState.style.display = 'none';

      const row = document.createElement('div');
      row.className = 'item-row';
      row.setAttribute('data-item-id', id);

      row.innerHTML = `
        <div class="item-row-header">
          <span class="item-row-number">Item #${itemCounter}</span>
          <button type="button" class="btn-remove" data-item-id="${id}">Remove</button>
        </div>
        <div class="item-fields">
          <div class="field-group">
            <label>Item Name *</label>
            <input type="text" class="item-name" placeholder="e.g., Play Booster Box">
          </div>
          <div class="field-group">
            <label>Item Code</label>
            <input type="text" class="item-code" placeholder="e.g., MH3-BBX">
          </div>
        </div>
        <div class="numbers-row">
          <div class="field-group">
            <label>Unit Cost</label>
            <input type="text" class="item-cost" placeholder="85">
          </div>
          <div class="field-group">
            <label>Unit Price</label>
            <input type="text" class="item-price" placeholder="115">
          </div>
          <div class="field-group">
            <label>Quantity *</label>
            <input type="number" class="item-qty" min="0" placeholder="12">
          </div>
        </div>
      `;

      document.getElementById('itemsContainer').appendChild(row);

      const nameInput = row.querySelector('.item-name');
      if (nameInput) nameInput.focus();

      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('btnImport').disabled = true;
    }

    function removeItemRow(id) {
      const row = document.querySelector('.item-row[data-item-id="' + id + '"]');
      if (row) row.remove();

      const remaining = document.querySelectorAll('.item-row');
      if (remaining.length === 0) {
        const emptyState = document.getElementById('emptyState');
        if (emptyState) emptyState.style.display = 'block';
        document.getElementById('previewSection').style.display = 'none';
        document.getElementById('btnImport').disabled = true;
      }
    }

    function collectFormData() {
      const setName = document.getElementById('setNameInput').value.trim();
      const items = [];
      const rows = document.querySelectorAll('.item-row');

      rows.forEach(function (row) {
        const name = (row.querySelector('.item-name') || {}).value || '';
        const code = (row.querySelector('.item-code') || {}).value || '';
        const cost = (row.querySelector('.item-cost') || {}).value || '';
        const price = (row.querySelector('.item-price') || {}).value || '';
        const qty = (row.querySelector('.item-qty') || {}).value || '';

        if (name.trim() || qty.toString().trim()) {
          items.push({
            itemName: name.trim(),
            itemCode: code.trim(),
            unitCost: cost.trim(),
            unitPrice: price.trim(),
            quantity: qty.toString().trim()
          });
        }
      });

      return { setName: setName, items: items };
    }

    function validateFormData(data) {
      const errors = [];

      if (!data.setName) {
        errors.push('Set Name is required.');
      }

      if (!data.items || data.items.length === 0) {
        errors.push('At least one item is required.');
      }

      data.items.forEach(function (item, index) {
        const n = index + 1;
        if (!item.itemName) {
          errors.push('Item #' + n + ': Item Name is required.');
        }
        if (!item.quantity) {
          errors.push('Item #' + n + ': Quantity is required.');
        } else {
          const q = parseInt(item.quantity, 10);
          if (isNaN(q) || q < 0) {
            errors.push('Item #' + n + ': Quantity must be a non-negative number.');
          }
        }
      });

      const names = new Set();
      data.items.forEach(function (item) {
        const key = item.itemName.toLowerCase();
        if (names.has(key)) {
          errors.push('Duplicate item name: "' + item.itemName + '" in this import.');
        } else {
          names.add(key);
        }
      });

      return errors;
    }

    function onPreview() {
      const data = collectFormData();
      const errors = validateFormData(data);

      if (errors.length > 0) {
        showStatus(errors.join('<br>'), 'error');
        document.getElementById('previewSection').style.display = 'none';
        document.getElementById('btnImport').disabled = true;
        return;
      }

      let html = '<div class="preview-set-name">Set: ' + escapeHtml(data.setName) + '</div>';
      data.items.forEach(function (item, idx) {
        const n = idx + 1;
        html += `
          <div class="preview-item">
            <strong>Item ${n}:</strong> ${escapeHtml(item.itemName)}
            ${item.itemCode ? ' (' + escapeHtml(item.itemCode) + ')' : ''}<br>
            <small>
              ${item.unitCost ? 'Cost: $' + escapeHtml(item.unitCost) + ' | ' : ''}
              ${item.unitPrice ? 'Price: $' + escapeHtml(item.unitPrice) + ' | ' : ''}
              Qty: ${escapeHtml(item.quantity)}
            </small>
          </div>
        `;
      });

      document.getElementById('previewContent').innerHTML = html;
      document.getElementById('previewSection').style.display = 'block';
      document.getElementById('btnImport').disabled = false;

      showStatus('✓ Preview ready: ' + data.items.length + ' item(s).', 'success');
    }

    function onImport() {
      const data = collectFormData();
      const errors = validateFormData(data);

      if (errors.length > 0) {
        showStatus(errors.join('<br>'), 'error');
        document.getElementById('btnImport').disabled = true;
        return;
      }

      showStatus('Importing to Preorders_Buckets...', 'info');
      document.getElementById('btnImport').disabled = true;

      google.script.run
        .withSuccessHandler(onImportSuccess)
        .withFailureHandler(onImportError)
        .importPreorderAllocationFromUI(data);
    }

    function onImportSuccess(result) {
      if (result && result.success) {
        const count = result.imported || (result.items ? result.items.length : 0) || 0;
        const setName = result.setName || '';
        showStatus(
          '✓ Imported ' + count + ' item(s)' +
          (setName ? ' for set "' + escapeHtml(setName) + '"' : '') + '.',
          'success'
        );
      } else {
        const msg = (result && result.error) ? result.error : 'Unknown error from server.';
        showStatus('Import failed: ' + escapeHtml(msg), 'error');
        document.getElementById('btnImport').disabled = false;
      }
    }

    function onImportError(error) {
      const msg = error && error.message ? error.message : String(error);
      showStatus('Error: ' + escapeHtml(msg), 'error');
      document.getElementById('btnImport').disabled = false;
    }

    function showStatus(message, type) {
      const el = document.getElementById('status');
      el.innerHTML = message;
      el.className = '';
      el.classList.add('status-' + type);
      el.style.display = 'block';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
