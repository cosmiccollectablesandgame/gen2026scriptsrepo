<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      font-size: 13px;
      margin: 0;
      padding: 8px 10px;
      background: #f5f5f5;
    }

    h2 {
      font-size: 18px;
      margin: 4px 0 2px;
      color: #c62828;
    }

    .subtitle {
      font-size: 11px;
      color: #666;
      margin-bottom: 8px;
    }

    .search-row {
      display: flex;
      gap: 4px;
      margin-bottom: 6px;
    }

    input[type="text"] {
      flex: 1;
      padding: 4px 6px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      font-size: 12px;
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
    }

    button:hover {
      background: #f0f0f0;
    }

    .list {
      max-height: 220px;
      overflow-y: auto;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 8px;
    }

    .preorder-row {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }

    .preorder-row:last-child {
      border-bottom: none;
    }

    .preorder-row:hover {
      background: #f0f7ff;
    }

    .preorder-row.selected {
      background: #e2f0ff;
      border-left: 3px solid #1a73e8;
    }

    .row-main {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }

    .customer {
      font-weight: 600;
    }

    .meta {
      color: #555;
      font-size: 11px;
    }

    .row-sub {
      font-size: 11px;
      color: #555;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .details {
      background: #fff;
      border-radius: 6px;
      border: 1px solid #ddd;
      padding: 6px 8px;
      margin-bottom: 8px;
      font-size: 11px;
      display: none;
    }

    .details.visible {
      display: block;
    }

    .details-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #333;
    }

    .details-row {
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
    }

    .details-label {
      color: #666;
    }

    .details-value {
      font-weight: 500;
    }

    .reason-section {
      margin-bottom: 8px;
    }

    .reason-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 2px;
    }

    textarea {
      width: 100%;
      font-size: 12px;
      padding: 4px 6px;
      resize: vertical;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      min-height: 50px;
    }

    .footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status {
      font-size: 11px;
      color: #777;
      margin-top: 4px;
      padding: 4px 6px;
      border-radius: 4px;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.info {
      background: #cce5ff;
      color: #004085;
    }

    .btn-danger {
      background: #c62828;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-weight: 500;
    }

    .btn-danger:hover {
      background: #a32020;
    }

    .btn-danger:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 12px;
    }

    .preorder-id {
      font-family: monospace;
      font-size: 10px;
      color: #888;
    }

    .status-badge {
      display: inline-block;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 500;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-paid {
      background: #d4edda;
      color: #155724;
    }

    .status-ready {
      background: #cce5ff;
      color: #004085;
    }
  </style>
</head>
<body>
  <h2>Cancel Preorder</h2>
  <p class="subtitle">Search for a preorder, select it, then cancel and optionally add a reason.</p>

  <div class="search-row">
    <input type="text" id="search" placeholder="Search by name, set, item, or ID" onkeydown="handleSearchKeydown(event)">
    <button onclick="loadPreorders()">Search</button>
  </div>

  <div id="listContainer" class="list">
    <div id="results"></div>
  </div>

  <div id="detailsPanel" class="details">
    <div class="details-title">Selected Preorder</div>
    <div class="details-row">
      <span class="details-label">Preorder ID:</span>
      <span class="details-value" id="detailId">-</span>
    </div>
    <div class="details-row">
      <span class="details-label">Customer:</span>
      <span class="details-value" id="detailCustomer">-</span>
    </div>
    <div class="details-row">
      <span class="details-label">Set / Item:</span>
      <span class="details-value" id="detailItem">-</span>
    </div>
    <div class="details-row">
      <span class="details-label">Quantity:</span>
      <span class="details-value" id="detailQty">-</span>
    </div>
    <div class="details-row">
      <span class="details-label">Balance Due:</span>
      <span class="details-value" id="detailBalance">-</span>
    </div>
    <div class="details-row">
      <span class="details-label">Status:</span>
      <span class="details-value" id="detailStatus">-</span>
    </div>
    <div class="details-row">
      <span class="details-label">Created:</span>
      <span class="details-value" id="detailCreated">-</span>
    </div>
  </div>

  <div class="reason-section">
    <div class="reason-label">Cancel Reason (optional):</div>
    <textarea id="reason" placeholder="e.g., Customer request, payment failed, item unavailable..."></textarea>
  </div>

  <div class="footer">
    <button class="btn-danger" id="cancelBtn" onclick="onCancelClick()" disabled>Cancel Preorder</button>
    <button onclick="loadPreorders()">Refresh</button>
  </div>

  <div id="status" class="status"></div>

  <script>
    // Global state
    var selectedPreorder = null;

    // Load preorders on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadPreorders();
    });

    function loadPreorders() {
      var filters = {
        search: document.getElementById('search').value.trim() || null,
        limit: 50
      };

      setStatus('Loading...', 'info');
      clearSelection();

      google.script.run
        .withSuccessHandler(renderPreorders)
        .withFailureHandler(function(err) {
          setStatus('Error: ' + (err && err.message ? err.message : err), 'error');
          document.getElementById('results').innerHTML = '<div class="empty-state">Failed to load preorders</div>';
        })
        .getCancelablePreorders(filters);
    }

    function renderPreorders(list) {
      var resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      if (!list || list.length === 0) {
        resultsDiv.innerHTML = '<div class="empty-state">No cancelable preorders found</div>';
        setStatus('No preorders to display', '');
        return;
      }

      list.forEach(function(preorder) {
        var row = document.createElement('div');
        row.className = 'preorder-row';
        row.setAttribute('data-preorder-id', preorder.Preorder_ID);

        var statusClass = getStatusClass(preorder.Status);
        var createdDate = formatDate(preorder.Created_At);
        var balance = formatCurrency(preorder.Balance_Due);

        row.innerHTML =
          '<div class="row-main">' +
            '<span class="customer">' + escapeHtml(preorder.preferred_name_id || 'Unknown') + '</span>' +
            '<span class="meta">' + escapeHtml(preorder.Set_Name) + '</span>' +
          '</div>' +
          '<div class="row-sub">' +
            '<span>' + escapeHtml(preorder.Item_Name) + ' (x' + preorder.Qty + ')</span>' +
            '<span class="status-badge ' + statusClass + '">' + escapeHtml(preorder.Status) + '</span>' +
          '</div>' +
          '<div class="row-sub">' +
            '<span class="preorder-id">' + escapeHtml(preorder.Preorder_ID) + '</span>' +
            '<span>Balance: ' + balance + '</span>' +
          '</div>';

        row.onclick = function() {
          selectPreorder(preorder, row);
        };

        resultsDiv.appendChild(row);
      });

      setStatus('Found ' + list.length + ' preorder(s)', '');
    }

    function selectPreorder(preorder, rowElement) {
      // Remove selection from all rows
      var rows = document.querySelectorAll('.preorder-row');
      rows.forEach(function(r) {
        r.classList.remove('selected');
      });

      // Select this row
      rowElement.classList.add('selected');
      selectedPreorder = preorder;

      // Update details panel
      document.getElementById('detailId').textContent = preorder.Preorder_ID;
      document.getElementById('detailCustomer').textContent = preorder.preferred_name_id || 'Unknown';
      document.getElementById('detailItem').textContent = preorder.Set_Name + ' - ' + preorder.Item_Name;
      document.getElementById('detailQty').textContent = preorder.Qty;
      document.getElementById('detailBalance').textContent = formatCurrency(preorder.Balance_Due);
      document.getElementById('detailStatus').textContent = preorder.Status;
      document.getElementById('detailCreated').textContent = formatDate(preorder.Created_At);

      // Show details panel
      document.getElementById('detailsPanel').classList.add('visible');

      // Enable cancel button
      document.getElementById('cancelBtn').disabled = false;
    }

    function clearSelection() {
      selectedPreorder = null;
      document.getElementById('detailsPanel').classList.remove('visible');
      document.getElementById('cancelBtn').disabled = true;

      var rows = document.querySelectorAll('.preorder-row');
      rows.forEach(function(r) {
        r.classList.remove('selected');
      });
    }

    function onCancelClick() {
      if (!selectedPreorder) {
        setStatus('Select a preorder first', 'error');
        return;
      }

      var reason = document.getElementById('reason').value.trim();
      var preorderId = selectedPreorder.Preorder_ID;
      var customerName = selectedPreorder.preferred_name_id || 'Unknown';

      // Confirm before cancelling
      var confirmMsg = 'Cancel preorder ' + preorderId + ' for ' + customerName + '?\n\n' +
                       'Item: ' + selectedPreorder.Item_Name + ' (x' + selectedPreorder.Qty + ')\n' +
                       'This will restore ' + selectedPreorder.Qty + ' unit(s) to the bucket.';

      if (!confirm(confirmMsg)) {
        return;
      }

      setStatus('Cancelling preorder...', 'info');
      document.getElementById('cancelBtn').disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          var msg = 'Preorder ' + result.preorderId + ' cancelled.';
          if (result.bucketAdjusted) {
            msg += ' Qty restored to bucket: ' + result.qtyRestored;
          } else {
            msg += ' (No bucket adjustment made)';
          }
          setStatus(msg, 'success');

          // Clear the reason field
          document.getElementById('reason').value = '';

          // Reload the list
          loadPreorders();
        })
        .withFailureHandler(function(err) {
          setStatus('Error: ' + (err && err.message ? err.message : err), 'error');
          document.getElementById('cancelBtn').disabled = false;
        })
        .cancelPreorder(preorderId, reason);
    }

    function handleSearchKeydown(event) {
      if (event.key === 'Enter') {
        loadPreorders();
      }
    }

    function setStatus(msg, type) {
      var statusDiv = document.getElementById('status');
      statusDiv.textContent = msg;
      statusDiv.className = 'status' + (type ? ' ' + type : '');
    }

    function getStatusClass(status) {
      if (!status) return '';
      var upper = status.toUpperCase();
      if (upper === 'PENDING') return 'status-pending';
      if (upper === 'PAID') return 'status-paid';
      if (upper === 'READY') return 'status-ready';
      return '';
    }

    function formatDate(dateVal) {
      if (!dateVal) return '-';
      try {
        var d = new Date(dateVal);
        if (isNaN(d.getTime())) return String(dateVal);
        return d.toLocaleDateString();
      } catch (e) {
        return String(dateVal);
      }
    }

    function formatCurrency(val) {
      var num = parseFloat(val) || 0;
      return '$' + num.toFixed(2);
    }

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>