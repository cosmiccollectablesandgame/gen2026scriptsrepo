<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; padding: 15px; font-size: 13px; }
    h3 { color: #1a73e8; margin-top: 0; }
    input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }

    .profile-container { margin-top: 15px; }

    .section { margin-bottom: 12px; padding: 12px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #1a73e8; }
    .section h4 { margin: 0 0 8px 0; color: #1a73e8; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    .section.economy { border-left-color: #34a853; }
    .section.economy h4 { color: #34a853; }
    .section.pipeline { border-left-color: #fbbc04; }
    .section.pipeline h4 { color: #9a7b00; }
    .section.missions { border-left-color: #ea4335; }
    .section.missions h4 { color: #ea4335; }
    .section.activity { border-left-color: #9334e6; }
    .section.activity h4 { color: #9334e6; }

    .stat-row { display: flex; justify-content: space-between; margin: 6px 0; font-size: 12px; }
    .stat-label { color: #666; }
    .stat-value { font-weight: 600; color: #333; max-width: 60%; text-align: right; word-break: break-word; }
    .stat-value.highlight { color: #1a73e8; }
    .stat-value.money { color: #34a853; }
    .stat-value.warning { color: #ea4335; }

    .player-name { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px; }
    .alt-names { font-size: 11px; color: #666; font-style: italic; }

    .quick-actions { margin-top: 15px; }
    button { width: 100%; padding: 8px; margin-top: 8px; border: none; border-radius: 4px; background: #1a73e8; color: white; cursor: pointer; font-size: 13px; }
    button:hover { background: #1557b0; }
    button.secondary { background: #5f6368; }
    button.secondary:hover { background: #3c4043; }

    #status { margin-top: 10px; padding: 8px; border-radius: 4px; font-size: 12px; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }

    .loading { text-align: center; color: #666; padding: 20px; }
    .meta-errors { font-size: 10px; color: #999; margin-top: 8px; }

    .notes-box { background: #fff3cd; padding: 8px; border-radius: 4px; font-size: 11px; color: #856404; margin-top: 8px; }
  </style>
</head>
<body>
  <h3>Player Lookup</h3>
  <input type="text" id="search" list="playerList" placeholder="Search player..." onchange="selectPlayer()">
  <datalist id="playerList"></datalist>

  <div id="loading" class="loading" style="display: none;">Loading profile...</div>

  <div id="profile" class="profile-container" style="display: none;">

    <!-- Identity Section -->
    <div class="section identity">
      <h4>Identity</h4>
      <div class="player-name" id="playerName"></div>
      <div class="alt-names" id="altNames"></div>
      <div class="stat-row"><span class="stat-label">Email:</span><span class="stat-value" id="email">-</span></div>
      <div class="stat-row"><span class="stat-label">Roll Profile:</span><span class="stat-value" id="rollProfile">-</span></div>
      <div class="stat-row"><span class="stat-label">Created:</span><span class="stat-value" id="created">-</span></div>
    </div>

    <!-- Economy Section -->
    <div class="section economy">
      <h4>Economy</h4>
      <div class="stat-row"><span class="stat-label">Store Credit:</span><span class="stat-value money" id="storeCredit">$0.00</span></div>
      <div class="stat-row"><span class="stat-label">Keys:</span><span class="stat-value" id="keys">0</span></div>
      <div class="stat-row"><span class="stat-label">Current BP:</span><span class="stat-value highlight" id="currentBP">0</span></div>
      <div class="stat-row"><span class="stat-label">Historical BP:</span><span class="stat-value" id="historicalBP">0</span></div>
    </div>

    <!-- Pipeline Section -->
    <div class="section pipeline">
      <h4>Pipeline</h4>
      <div class="stat-row"><span class="stat-label">Preorders:</span><span class="stat-value" id="preorders">None</span></div>
      <div class="stat-row"><span class="stat-label">This Needs:</span><span class="stat-value" id="thisNeeds">None</span></div>
    </div>

    <!-- Missions Section -->
    <div class="section missions">
      <h4>Missions & Awards</h4>
      <div class="stat-row"><span class="stat-label">Missions Completed:</span><span class="stat-value" id="missionsCompleted">0</span></div>
      <div class="stat-row"><span class="stat-label">Awards:</span><span class="stat-value" id="awards">-</span></div>
    </div>

    <!-- Activity Section -->
    <div class="section activity">
      <h4>Activity</h4>
      <div class="stat-row"><span class="stat-label">Last Visit:</span><span class="stat-value" id="lastVisit">Never</span></div>
      <div class="stat-row"><span class="stat-label">Lifetime Visits:</span><span class="stat-value" id="lifetimeVisits">0</span></div>
      <div class="stat-row"><span class="stat-label">Primary Format:</span><span class="stat-value" id="primaryFormat">-</span></div>
      <div id="notesContainer" style="display: none;">
        <div class="notes-box" id="notes"></div>
      </div>
    </div>

    <div class="quick-actions">
      <button onclick="openAddKey()">Add Key</button>
      <button onclick="openRedeemBP()">Redeem BP</button>
      <button class="secondary" onclick="viewHistory()">View Credit History</button>
    </div>

    <div class="meta-errors" id="metaErrors"></div>
  </div>

  <div id="status"></div>

  <script>
    var state = {
      selectedPlayer: null,
      profile: null
    };

    // Load player names on init
    google.script.run
      .withSuccessHandler(populatePlayers)
      .withFailureHandler(function(e) { showStatus('Failed to load players: ' + e.message, 'error'); })
      .getPlayerNames();

    function populatePlayers(names) {
      var datalist = document.getElementById('playerList');
      datalist.innerHTML = '';
      names.forEach(function(name) {
        var option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
      });
    }

    function selectPlayer() {
      var playerName = document.getElementById('search').value.trim();
      if (!playerName) return;

      state.selectedPlayer = playerName;

      // Show loading, hide profile
      document.getElementById('loading').style.display = 'block';
      document.getElementById('profile').style.display = 'none';
      clearStatus();

      // Load full profile in one shot
      google.script.run
        .withSuccessHandler(onProfileLoaded)
        .withFailureHandler(onProfileError)
        .getPlayerProfile(playerName);
    }

    function onProfileLoaded(profile) {
      document.getElementById('loading').style.display = 'none';

      if (!profile) {
        showStatus('No profile data returned', 'error');
        return;
      }

      state.profile = profile;

      // Identity
      document.getElementById('playerName').textContent = profile.identity.PreferredName || state.selectedPlayer;
      document.getElementById('altNames').textContent = profile.identity.Alt_Names ? 'aka: ' + profile.identity.Alt_Names : '';
      document.getElementById('email').textContent = profile.identity.Email || '-';
      document.getElementById('rollProfile').textContent = profile.identity.Roll_Profile || '-';
      document.getElementById('created').textContent = formatDate(profile.identity.Created) || '-';

      // Economy
      document.getElementById('storeCredit').textContent = formatCurrency(profile.economy.Store_Credit);
      document.getElementById('keys').textContent = profile.economy.Keys || 0;
      document.getElementById('currentBP').textContent = profile.economy.Current_BP || 0;
      document.getElementById('historicalBP').textContent = profile.economy.Historical_BP || 0;

      // Pipeline
      document.getElementById('preorders').textContent = profile.pipeline.Preorders || 'None';
      document.getElementById('thisNeeds').textContent = profile.pipeline.This_Needs || 'None';

      // Missions
      document.getElementById('missionsCompleted').textContent = profile.missions.Missions_Completed || 0;
      document.getElementById('awards').textContent = profile.missions.Awards || '-';

      // Activity
      document.getElementById('lastVisit').textContent = profile.activity.Last_Visit || 'Never';
      document.getElementById('lifetimeVisits').textContent = profile.activity.Lifetime_Visits || 0;
      document.getElementById('primaryFormat').textContent = profile.activity.Primary_Format || '-';

      // Notes
      var notesContainer = document.getElementById('notesContainer');
      var notesEl = document.getElementById('notes');
      if (profile.activity.Notes) {
        notesEl.textContent = profile.activity.Notes;
        notesContainer.style.display = 'block';
      } else {
        notesContainer.style.display = 'none';
      }

      // Meta errors (for debugging)
      var metaErrors = document.getElementById('metaErrors');
      if (profile.meta && profile.meta.errors && profile.meta.errors.length > 0) {
        metaErrors.textContent = 'Warnings: ' + profile.meta.errors.join('; ');
      } else {
        metaErrors.textContent = '';
      }

      document.getElementById('profile').style.display = 'block';
    }

    function onProfileError(error) {
      document.getElementById('loading').style.display = 'none';
      showStatus('Error loading profile: ' + (error.message || error), 'error');
    }

    function formatCurrency(val) {
      var num = parseFloat(val) || 0;
      return '$' + num.toFixed(2);
    }

    function formatDate(val) {
      if (!val) return '';
      if (val instanceof Date) {
        return val.toLocaleDateString();
      }
      return String(val);
    }

    function openAddKey() {
      if (!state.selectedPlayer) {
        showStatus('Select a player first', 'info');
        return;
      }
      google.script.run.onAddKey();
    }

    function openRedeemBP() {
      if (!state.selectedPlayer) {
        showStatus('Select a player first', 'info');
        return;
      }
      google.script.run.onRedeemBP();
    }

    function viewHistory() {
      if (!state.selectedPlayer) {
        showStatus('Select a player first', 'info');
        return;
      }
      google.script.run
        .withSuccessHandler(displayHistory)
        .withFailureHandler(onProfileError)
        .getPlayerHistory(state.selectedPlayer, 10);
    }

    function displayHistory(txns) {
      if (!txns || txns.length === 0) {
        showStatus('No credit history found', 'info');
        return;
      }
      var msg = 'Recent transactions:\n';
      txns.forEach(function(t) {
        var sign = t.direction === 'credit' ? '+' : '-';
        msg += sign + '$' + t.amount.toFixed(2) + ' - ' + (t.reason || t.description || 'N/A') + '\n';
      });
      showStatus(msg, 'info');
    }

    function showStatus(message, type) {
      var status = document.getElementById('status');
      status.textContent = message;
      status.className = type || '';
      status.style.display = 'block';
    }

    function clearStatus() {
      var status = document.getElementById('status');
      status.textContent = '';
      status.className = '';
      status.style.display = 'none';
    }
  </script>
</body>
</html>