<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; font-size: 14px; }
    h2 { color: #1a73e8; }
    .actions { margin-bottom: 20px; }
    button { padding: 10px 15px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #1a73e8; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #333; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px; }
    th { background: #4285f4; color: white; padding: 8px; text-align: left; position: sticky; top: 0; }
    td { padding: 6px; border-bottom: 1px solid #ddd; }
    input.table-input { width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 3px; }
    #status { margin-top: 15px; padding: 10px; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <h2>Manage Prize Catalog</h2>

  <div class="actions">
    <button class="btn-primary" onclick="normalizeHeaders()">Normalize Headers</button>
    <button class="btn-success" onclick="dryRun()">Dry Run (Test)</button>
    <button class="btn-warning" onclick="saveChanges()">Save Changes</button>
  </div>

  <div style="max-height: 400px; overflow-y: auto;">
    <table id="catalogTable">
      <thead>
        <tr><th>Code</th><th>Name</th><th>Level</th><th>COGS</th><th>Qty</th><th>InStock</th></tr>
      </thead>
      <tbody id="catalogBody"></tbody>
    </table>
  </div>

  <div id="status"></div>

  <script>
    let catalogData = [];
    loadCatalog();

    function loadCatalog() {
      google.script.run.withSuccessHandler(displayCatalog).getCatalog();
    }

    function displayCatalog(catalog) {
      catalogData = catalog;
      const tbody = document.getElementById('catalogBody');
      tbody.innerHTML = '';

      catalog.forEach((item, idx) => {
        tbody.innerHTML += `<tr>
          <td>${item.Code}</td>
          <td>${item.Name}</td>
          <td>${item.Level}</td>
          <td><input class="table-input" type="number" step="0.01" value="${item.COGS || 0}" data-idx="${idx}" data-field="COGS"></td>
          <td><input class="table-input" type="number" value="${item.Qty || 0}" data-idx="${idx}" data-field="Qty"></td>
          <td>${item.InStock ? 'Yes' : 'No'}</td>
        </tr>`;
      });
    }

    function normalizeHeaders() {
      showStatus('Normalizing headers...', 'info');
      google.script.run
        .withSuccessHandler(result => {
          showStatus(`✓ ${result.applied ? 'Headers normalized: ' + result.mappings.length + ' synonyms mapped' : 'No changes needed'}`, 'success');
          loadCatalog();
        })
        .withFailureHandler(onFailure)
        .normalizeHeaders();
    }

    function dryRun() {
      showStatus('Running dry-run...', 'info');
      google.script.run
        .withSuccessHandler(result => {
          showStatus(`✓ Dry-run complete: Tested ${result.events_tested} events, found ${result.issues_found} issues`, result.issues_found > 0 ? 'warning' : 'success');
        })
        .withFailureHandler(onFailure)
        .dryRunAgainstEvents(3);
    }

    function saveChanges() {
      const edits = [];
      document.querySelectorAll('.table-input').forEach(input => {
        const idx = parseInt(input.dataset.idx);
        const field = input.dataset.field;
        const value = parseFloat(input.value);
        const original = catalogData[idx][field];

        if (value !== original) {
          edits.push({
            code: catalogData[idx].Code,
            field: field,
            value: value
          });
        }
      });

      if (edits.length === 0) {
        showStatus('No changes to save', 'warning');
        return;
      }

      if (!confirm(`Save ${edits.length} change(s)?`)) return;

      showStatus('Saving...', 'info');
      google.script.run
        .withSuccessHandler(() => {
          showStatus(`✓ Saved ${edits.length} change(s)`, 'success');
          loadCatalog();
        })
        .withFailureHandler(onFailure)
        .updateItems(edits);
    }

    function onFailure(error) {
      showStatus(`Error: ${error.message}`, 'error');
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = type;
    }
  </script>
</body>
</html>