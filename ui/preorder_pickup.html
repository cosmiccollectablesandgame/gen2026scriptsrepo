<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      font-size: 14px;
      color: #333;
    }
    h2 {
      color: #1a73e8;
      margin-top: 0;
      margin-bottom: 8px;
    }
    .subtitle {
      color: #666;
      font-size: 13px;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 16px;
      margin-bottom: 6px;
      font-weight: 600;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    select:disabled {
      background: #f5f5f5;
      color: #999;
    }
    .buttons {
      margin-top: 24px;
      text-align: right;
    }
    button {
      padding: 10px 20px;
      margin-left: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    .btn-primary {
      background: #1a73e8;
      color: white;
    }
    .btn-primary:hover {
      background: #1557b0;
    }
    .btn-primary:disabled {
      background: #a0c4f1;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #f1f3f4;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e1e3e4;
    }
    #status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 4px;
      font-size: 13px;
    }
    .status-info {
      background: #e8f4fd;
      color: #1967d2;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
    }
    .status-error {
      background: #f8d7da;
      color: #721c24;
    }
    .status-warning {
      background: #fff3cd;
      color: #856404;
    }
    .hidden {
      display: none;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h2>Mark Preorder Picked Up</h2>
  <p class="subtitle">Choose a preorder that is fully paid and mark it as picked up.</p>

  <label for="preorderSelect">Select Preorder</label>
  <select id="preorderSelect" disabled>
    <option value="">Loading preorders...</option>
  </select>

  <label for="staffInitials">Staff Initials</label>
  <input type="text" id="staffInitials" placeholder="e.g., RB" maxlength="10">

  <div id="status" class="hidden"></div>

  <div class="buttons">
    <button class="btn-secondary" onclick="google.script.host.close()">Cancel</button>
    <button id="submitBtn" class="btn-primary" onclick="onSubmit()" disabled>Mark Picked Up</button>
  </div>

  <script>
    // Store preorders data
    let preordersData = [];

    // Load preorders on page load
    loadPreorders();

    function loadPreorders() {
      showStatus('Loading preorders...', 'info');

      google.script.run
        .withSuccessHandler(onPreordersLoaded)
        .withFailureHandler(onLoadError)
        .getPreordersReadyForPickup();
    }

    function onPreordersLoaded(preorders) {
      preordersData = preorders || [];
      const select = document.getElementById('preorderSelect');
      const submitBtn = document.getElementById('submitBtn');

      // Clear existing options
      select.innerHTML = '';

      if (preordersData.length === 0) {
        // No preorders ready
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No preorders are currently ready for pickup.';
        option.disabled = true;
        select.appendChild(option);
        select.disabled = true;
        submitBtn.disabled = true;
        showStatus('No preorders are ready for pickup. Preorders must be fully paid (Balance Due = $0) to appear here.', 'warning');
      } else {
        // Add placeholder option
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = '-- Select a preorder --';
        select.appendChild(placeholder);

        // Add preorder options
        preordersData.forEach(preorder => {
          const option = document.createElement('option');
          option.value = preorder.preorderId;

          // Format: PO-123 - Alice Example - SET NAME (x2)
          let label = preorder.preorderId;
          if (preorder.preferredName) {
            label += ' - ' + preorder.preferredName;
          }
          if (preorder.setName) {
            label += ' - ' + preorder.setName;
          } else if (preorder.itemName) {
            label += ' - ' + preorder.itemName;
          }
          label += ' (x' + preorder.qty + ')';

          option.textContent = label;
          select.appendChild(option);
        });

        select.disabled = false;
        submitBtn.disabled = false;
        hideStatus();
      }
    }

    function onLoadError(error) {
      const select = document.getElementById('preorderSelect');
      select.innerHTML = '<option value="" disabled>Error loading preorders</option>';
      select.disabled = true;
      document.getElementById('submitBtn').disabled = true;
      showStatus('Error loading preorders: ' + (error.message || error), 'error');
    }

    function onSubmit() {
      const select = document.getElementById('preorderSelect');
      const staffInput = document.getElementById('staffInitials');
      const preorderId = select.value;
      const staffInitials = staffInput.value.trim();

      // Validation
      if (!preorderId) {
        showStatus('Please select a preorder from the list.', 'error');
        return;
      }

      if (!staffInitials) {
        showStatus('Please enter your staff initials.', 'error');
        staffInput.focus();
        return;
      }

      // Disable form while submitting
      setFormLoading(true);
      showStatus('Updating preorder...', 'info');

      google.script.run
        .withSuccessHandler(onSubmitSuccess)
        .withFailureHandler(onSubmitError)
        .markPreorderPickedUp(preorderId, staffInitials);
    }

    function onSubmitSuccess(result) {
      setFormLoading(false);
      showStatus('Preorder ' + result.preorderId + ' marked as picked up.', 'success');

      // Reload the list to remove the picked-up preorder
      setTimeout(loadPreorders, 1500);
    }

    function onSubmitError(error) {
      setFormLoading(false);
      showStatus('Error: ' + (error.message || error), 'error');
    }

    function setFormLoading(loading) {
      const select = document.getElementById('preorderSelect');
      const staffInput = document.getElementById('staffInitials');
      const submitBtn = document.getElementById('submitBtn');

      if (loading) {
        select.disabled = true;
        staffInput.disabled = true;
        submitBtn.disabled = true;
        document.body.classList.add('loading');
      } else {
        select.disabled = preordersData.length === 0;
        staffInput.disabled = false;
        submitBtn.disabled = preordersData.length === 0;
        document.body.classList.remove('loading');
      }
    }

    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status-' + type;
    }

    function hideStatus() {
      const status = document.getElementById('status');
      status.className = 'hidden';
    }
  </script>
</body>
</html>